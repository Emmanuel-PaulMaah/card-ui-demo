<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Friend Cards – unified gestures</title>
<style>
  :root{
    --card-w: clamp(280px, 92vw, 420px);
    --radius: 16px;
    --shadow: 0 10px 30px rgba(0,0,0,.15);

    /* transform state */
    --tx: 0px;         /* translateX */
    --ty: 0px;         /* translateY */
    --rz: 0deg;        /* rotateZ (tilt) */
    --ry: 0deg;        /* rotateY (flip/spin) */
  }

  *{box-sizing:border-box}
  body{
    margin:0;min-height:100dvh;display:grid;place-items:center;background:#f6f7fb;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif
  }
  .wrap{width:min(96vw,560px);padding:10px}
  .status{text-align:center;margin-bottom:12px;font-size:14px;color:#555}

  .stage{
    width:var(--card-w);
    aspect-ratio: 320 / 460;
    margin:auto;perspective:1200px;position:relative
  }

  .card{
    position:absolute;inset:0;border-radius:var(--radius);box-shadow:var(--shadow);
    transform-style:preserve-3d;
    /* compose transforms from vars so animations don’t clash */
    transform: translate(var(--tx), var(--ty)) rotate(var(--rz)) rotateY(var(--ry));
    transition: transform .35s cubic-bezier(.22,.61,.36,1);
    touch-action:none; background:#000; overflow:hidden; isolation:isolate;
    will-change: transform;
  }

  .side{
    position:absolute;inset:0;backface-visibility:hidden;-webkit-backface-visibility:hidden;
    border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column
  }

  /* FRONT: full-bleed image bg with gradient overlays */
  .front{
    color:#fff; display:flex; flex-direction:column; justify-content:flex-end;
  }
  .bg{
    position:absolute; inset:0; z-index:-1;
    background:#111 center/cover no-repeat;
    transform:scale(1.02);
    filter:saturate(1.02);
  }
  .front::before{
    content:""; position:absolute; inset:0; z-index:0;
    background: linear-gradient(180deg, rgba(0,0,0,0.05) 20%, rgba(0,0,0,0.5) 75%);
  }
  .header{
    position:absolute; left:0; right:0; top:0; display:flex; align-items:center; justify-content:space-between;
    padding:14px 16px;
  }
  .name{font-weight:700;font-size:clamp(16px, 3.8vw, 20px);padding:6px 10px;border-radius:10px;background:rgba(238,242,255,.85);color:#3730a3;backdrop-filter:blur(6px)}
  .gem{display:inline-flex;align-items:center;gap:6px;background:rgba(236,254,255,.9);color:#155e75;padding:6px 10px;border-radius:12px;font-weight:700;font-size:clamp(13px, 3.5vw, 15px)}
  .gem::before{content:"♦"}

  .hint{
    margin-top:auto;font-size:12px;color:#e5e7eb;opacity:.9;padding:10px 12px 12px;text-align:center
  }

  /* BACK */
  .back{
    background:#111827;color:#e5e7eb;transform:rotateY(180deg);padding:14px;gap:12px
  }
  .row{display:flex;justify-content:space-between;align-items:center;background:#1f2937;padding:12px 14px;border-radius:12px}
  .row+.row{margin-top:10px}
  .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:0;background:#22c55e;color:#fff;font-weight:700;cursor:pointer}
  .nav{display:flex;justify-content:space-between;gap:8px;margin-top:14px}
  .nav button{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #374151;background:#111827;color:#e5e7eb;cursor:pointer;font-weight:600}
  .nav button.btn{border:0;background:#22c55e;color:#fff}

  .index{text-align:center;margin-top:10px;color:#6b7280;font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <div class="status">tap = spin 360° and show bio · drag left/right = next/prev · drag up = next · double = call</div>

  <div class="stage">
    <div class="card" id="card">
      <!-- FRONT -->
      <div class="side front">
        <div class="bg" id="bg"></div>
        <div class="header">
          <div class="name" id="name">name</div>
          <div class="gem" id="gems">0</div>
        </div>
        <div class="hint">tap once to spin & reveal bio · swipe left/right to browse · swipe up to advance</div>
      </div>

      <!-- BACK -->
      <div class="side back">
        <div class="row"><span>username</span> <strong id="username">@handle</strong></div>
        <div class="row"><span>bio</span> <span id="bio">—</span></div>
        <div class="row"><span>phone</span> <strong id="phone">—</strong></div>
        <div class="nav">
          <button id="flipBack">flip to front</button>
          <button id="callBtn" class="btn">call</button>
        </div>
      </div>
    </div>
  </div>

  <div class="index" id="index"></div>
</div>

<script>
  // ---------- demo data ----------
  const friends = [
    { name:"john", gems:12, avatar:"https://i.pravatar.cc/640?img=12", username:"@johnny", bio:"product nerd. weekend cook.", phone:"+15550101" },
    { name:"maya", gems:47, avatar:"https://i.pravatar.cc/640?img=5",  username:"@maya",   bio:"design + dogs.",           phone:"+15550102" },
    { name:"dev",  gems:3,  avatar:"https://i.pravatar.cc/640?img=33", username:"@dev",    bio:"runner. reads a lot.",     phone:"+15550103" },
  ];

  // ---------- elements ----------
  const els = {
    card: document.getElementById('card'),
    bg: document.getElementById('bg'),
    name: document.getElementById('name'),
    gems: document.getElementById('gems'),
    username: document.getElementById('username'),
    bio: document.getElementById('bio'),
    phone: document.getElementById('phone'),
    flipBack: document.getElementById('flipBack'),
    callBtn: document.getElementById('callBtn'),
    index: document.getElementById('index'),
  };

  let i = 0;
  let spinning = false;       // prevents gesture jitter during spin
  let showingBack = false;    // logical state of which face we intend to show
  let ryDeg = 0;              // rotateY in degrees (source of truth)

  function applyTransformVars(tx=0, ty=0, rz=0, ry=ryDeg){
    els.card.style.setProperty('--tx', tx+'px');
    els.card.style.setProperty('--ty', ty+'px');
    els.card.style.setProperty('--rz', rz+'deg');
    els.card.style.setProperty('--ry', ry+'deg');
  }

  function render(idx){
    const f = friends[idx];
    els.name.textContent = f.name;
    els.gems.textContent = f.gems;
    els.bg.style.backgroundImage = `url("${f.avatar}")`;
    els.username.textContent = f.username;
    els.bio.textContent = f.bio;
    els.phone.textContent = f.phone;
    els.index.textContent = `${idx+1} / ${friends.length}`;

    // normalize orientation to front by default when switching cards
    showingBack = false;
    ryDeg = 0;
    applyTransformVars(0,0,0,ryDeg);
  }

  function callFriend(){
    const phone = friends[i]?.phone;
    if (!phone) { alert("no phone on file."); return; }
    const num = phone.replace(/\s+/g,'');
    window.location.href = `tel:${num}`;
  }

  function next(dir=1){
    i = (i + dir + friends.length) % friends.length;
    render(i);
  }

  // ---------- tap spin (360° visual, ends on opposite face) ----------
  function spinAndReveal(){
    if (spinning) return;
    spinning = true;

    // target: full spin (360) + flip (additional 180) so we end on the other face without a snap
    const delta = 540; // 360 + 180
    const start = ryDeg;
    const end = ryDeg + delta;

    // use WAAPI for glitch-free animation; composite: replace (we drive CSS vars)
    const anim = els.card.animate(
      [
        { transform: `translate(var(--tx), var(--ty)) rotate(var(--rz)) rotateY(${start}deg)` },
        { transform: `translate(var(--tx), var(--ty)) rotate(var(--rz)) rotateY(${end}deg)` }
      ],
      { duration: 550, easing: 'cubic-bezier(.22,.61,.36,1)', fill: 'both' }
    );

    anim.onfinish = () => {
      ryDeg = end % 360;              // keep within 0..359
      showingBack = !showingBack;     // we ended flipped
      applyTransformVars(0,0,0,ryDeg);
      spinning = false;
    };
    anim.oncancel = () => { spinning = false; };
  }

  // ---------- unified gestures (X + Y) ----------
  let dragging=false, startX=0, startY=0, curX=0, curY=0;

  const SWIPE_X = 90;           // horizontal change to count as left/right
  const SWIPE_Y = 100;          // upward change to count as next
  const ROTATE_FACTOR = 18;     // z-rotation on horizontal drag
  const TRANSLATE_X_LIMIT = 140;
  const TRANSLATE_Y_LIMIT = 120;

  // tap/double-tap detection (for call)
  let lastTapTime = 0, lastTapX = 0, lastTapY = 0;
  const DOUBLE_MS = 280, DOUBLE_DIST = 18;

  function setDrag(dx, dy){
    const cx = Math.max(-TRANSLATE_X_LIMIT, Math.min(TRANSLATE_X_LIMIT, dx));
    const cy = Math.max(-TRANSLATE_Y_LIMIT, Math.min(TRANSLATE_Y_LIMIT, dy));
    const rot = (cx/TRANSLATE_X_LIMIT)*ROTATE_FACTOR;
    els.card.style.transition='none';
    applyTransformVars(cx, cy, rot, ryDeg);
  }

  function resetDrag(){
    els.card.style.transition='transform .35s cubic-bezier(.22,.61,.36,1)';
    applyTransformVars(0,0,0,ryDeg);
  }

  function flingHorizontal(dir){
    els.card.style.transition='transform .22s ease-out';
    // temporarily animate out without touching ryDeg
    els.card.style.transform = `translate(${dir*420}px, 0px) rotate(${dir*30}deg) rotateY(${ryDeg}deg)`;
    setTimeout(()=>{ next(dir); els.card.style.transition=''; els.card.style.transform=''; }, 200);
  }

  function flingUp(){
    els.card.style.transition='transform .25s ease-out';
    els.card.style.transform = `translate(0px, -480px) rotate(-6deg) rotateY(${ryDeg}deg)`;
    setTimeout(()=>{ next(1); els.card.style.transition=''; els.card.style.transform=''; }, 220);
  }

  els.card.addEventListener('pointerdown',(e)=>{
    if (spinning) return; // ignore during spin
    dragging=true; startX=e.clientX; startY=e.clientY; curX=startX; curY=startY;
    els.card.setPointerCapture(e.pointerId);
  });

  els.card.addEventListener('pointermove',(e)=>{
    if(!dragging || spinning) return;
    curX=e.clientX; curY=e.clientY;
    setDrag(curX-startX, curY-startY);
  });

  els.card.addEventListener('pointerup',(e)=>{
    if(!dragging) return;
    dragging=false;
    els.card.releasePointerCapture(e.pointerId);

    const dx = curX - startX;
    const dy = curY - startY;

    // gestures (no like):
    if (-dy > SWIPE_Y) { flingUp(); return; }                   // swipe up → next
    if (Math.abs(dx) > SWIPE_X) { flingHorizontal(dx<0?-1:1); return; } // left/right → prev/next

    resetDrag(); // not a swipe → treat as tap/double

    // if we moved a bit, don’t count as tap
    const moveDist = Math.hypot(dx, dy);
    if (moveDist > 8) return;

    const now = performance.now();
    const dt = now - lastTapTime;
    const dist = Math.hypot(e.clientX-lastTapX, e.clientY-lastTapY);

    if (dt < DOUBLE_MS && dist < DOUBLE_DIST) {
      lastTapTime = 0;
      callFriend();
      return;
    }

    // single tap → 360° spin and end on opposite face
    spinAndReveal();

    lastTapTime = now; lastTapX = e.clientX; lastTapY = e.clientY;
  });

  // native dblclick (desktop) → call
  els.card.addEventListener('dblclick', ()=>{
    lastTapTime = 0;
    callFriend();
  });

  // buttons
  els.flipBack.addEventListener('click', ()=>{
    // simulate a tap spin back to front
    spinAndReveal();
  });
  els.callBtn.addEventListener('click', callFriend);

  // keyboard niceties
  window.addEventListener('keydown',(e)=>{
    if(e.key==='ArrowRight') next(1);
    if(e.key==='ArrowLeft') next(-1);
    if(e.key===' ') { e.preventDefault(); spinAndReveal(); }
    if(e.key.toLowerCase()==='u') flingUp(); // quick test
  });

  render(i);
</script>
</body>
</html>
